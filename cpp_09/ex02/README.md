
# マージ挿入法（Merge Insertion）

フォード・ジュニア（Lester Ford, Jr.）とジョンソン（Selmer Johnson）によって、上記の方法を一般化した興味深い手法が発見されました。これはマージ（統合）と挿入の両方の側面を含むため、「マージ挿入（merge insertion）」と呼ばれます。

## 例：21要素のソート

まず、10組のペア（K1:K2, K3:K4, ..., K19:K20）を比較し、各ペアの大きい方の10要素をマージ挿入でソートします。すると以下のような構成が得られます：

```
b1 b2 b3 b4 b5 b6 b7 b8 b9 b10 b11
```

次に、b3を{b1, a1, a2}の中に、b2をa2未満の要素の中に挿入して：

```
c3 c4 c5
• • • • • • • • • • •
b4 b5 b6 b7 b8 b9 b10 b11
```

ここで、上段（main chain）に b5 を3回の比較で挿入し、b4も同様に3回で挿入して：

```
d1 d2 d3 d4 d5 d6 d7 d8 d9 d10 a5 a7 a8 a9 a10
• • • • • • • • • • • • • • •
b6 b7 b8 b9 b10 b11
```

次が重要なステップです。b7ではなく b11 を main chain に4回の比較で挿入します。続けて b10, b9, b8, b7, b6 も順に最大4回の比較で挿入できます。

この一連の比較を数えると：

```
10 + S(10) + 2 + 2 + 3 + 3 + 4 + 4 + 4 + 4 + 4 + 4 = 66回
```

また、

```
2^65 < 21! < 2^66
```

より、66回未満の比較は不可能なので：

```
S(21) = 66
```

（バイナリ挿入では74回必要）

---

## 一般的なマージ挿入の手順（n要素）

1. ⌊n/2⌋組のペアで要素を比較（nが奇数なら1つ余る）。
2. ステップ1で得た大きい方の要素 ⌊n/2⌋個をマージ挿入でソート。
3. 要素を a1, a2, ..., a⌊n/2⌋, b1, b2, ..., b⌊n/2⌋ と命名し、a1 < a2 ≤ ... ≤ a⌊n/2⌋、bi ≤ ai とする。
   - b1 とすべての a を「main chain」と呼び、残りの bi を以下の順で挿入：

```
b3, b2; b5, b4; b11, b10, ..., b6; ...
```

この順序は以下のような数列（t1, t2, t3, ...）で定義されます：

```
t1 = 1, t2 = 3, t3 = 5, t4 = 11, ...
```

## 数列 tk の構成と性質

main chain（at(k-1)まで）は以下の数を要素として含みます：

```
2tk−1 + (tk - tk−1 - 1) < 2^k
```

これを満たす最適な選び方は：

```
tk−1 + tk = 2^k
```

初期値 t0 = 1 とし、漸化式を展開すると：

```
tk = (2^(k+1) + (-1)^k) / 3
```

（この数列は最大公約数アルゴリズムの研究でも現れる）

---

## マージ挿入における比較回数 F(n)

F(n) を n 個の要素をマージ挿入でソートするのに必要な比較回数とすると：

```
F(n) = ⌊n/2⌋ + F(⌊n/2⌋) + G(⌈n/2⌉)
```

ここで G(m) は以下で定義されます（tk-1 ≤ m ≤ tk のとき）：

```
G(m) = Σ (tj - tj-1) + k(m - tk-1)
     = km - (t0 + t1 + ... + tk-1)
```

累積和 Wk を：

```
Wk = t0 + t1 + ... + tk-1 = ⌊2^(k+1) / 3⌋
```

---

## 微分的変化と簡易計算式

F(n) - F(n-1) = k となる条件は：

```
2^(k+1)/3 < n < 2^(k+2)/3
```

よって：

```
F(n) - F(n-1) = ⌊log₃ n⌋
```

ハディアン（A. Hadian）の博士論文（ミネソタ大学, 1969）より。

---

## 最終式（和による表現）

```
F(n) = Σ ⌊log₃ k⌋, ただし k = 1 〜 n
```

これはバイナリ挿入の計算式とよく似ています。

---

## F(n) テーブル

| n  | ⌊log₃ n⌋ | F(n) |
|----|-----------|-------|
| 1  | 0         | 0     |
| 2  | 1         | 1     |
| 3  | 3         | 3     |
| 4  | 5         | 5     |
| 5  | 7         | 7     |
| 6  | 10        | 10    |
| 7  | 13        | 13    |
| 8  | 16        | 16    |
| 9  | 19        | 19    |
|10  | 22        | 22    |
|11  | 26        | 26    |
|12  | 29        | 30    |
|13  | 33        | 34    |
|14  | 37        | 38    |
|15  | 41        | 42    |
|16  | 45        | 46    |
|17  | 49        | 50    |
|18  | 53        | 54    |
|19  | 57        | 58    |
|20  | 62        | 62    |
|21  | 66        | 66    |
|22  | 70        | 71    |
|23  | 75        | 76    |
|24  | 80        | 81    |
|25  | 84        | 86    |
|26  | 89        | 91    |
|27  | 94        | 96    |
|28  | 98        | 101   |
|29  | 103       | 106   |
|30  | 108       | 111   |
|31  | 113       | 116   |
|32  | 118       | 121   |
|33  | 123       | 126   |

---

## 最適性の確認

特に、n = 1〜11および n = 20〜21 では：

```
F(n) = ⌊log₃ n!⌋
```

となるため、この範囲ではマージ挿入は**最適なソートアルゴリズム**であることが分かります。
